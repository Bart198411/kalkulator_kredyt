<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator kredytu got√≥wkowego ‚Äì offline</title>
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #0f151c;
      --panel-2:#121a23;
      --text: #e6edf3;
      --muted:#a9b4bf;
      --accent: #61dafb;
      --accent-2:#7ee787;
      --danger:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fa; --panel:#ffffff; --panel-2:#f1f5f9; --text:#0b1220; --muted:#425466; --accent:#0070f3; --accent-2:#0ea5e9; --danger:#e11d48; --shadow: 0 10px 24px rgba(2,6,23,.08);} 
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:radial-gradient(1200px 800px at 80% -10%, rgba(97,218,251,.12), transparent), radial-gradient(900px 600px at -10% 100%, rgba(14,165,233,.10), transparent), var(--bg); color:var(--text)}
    .container{max-width:1200px;margin:40px auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:20px}
    h1{margin:0;font-size:clamp(22px,3vw,32px);letter-spacing:.3px}
    .sub{color:var(--muted);font-size:14px}

    .grid{display:grid;grid-template-columns: 1.1fr .9fr; gap: 20px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;}}

    .card{background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid rgba(148,163,184,.18); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card .inner{padding:18px 18px}

    .row{display:grid; grid-template-columns: 1fr 130px; gap:16px; align-items:center; margin:14px 0}
    .row .label{font-weight:600; font-size:14px}
    .row .desc{font-size:12px;color:var(--muted);margin-top:4px}

    .slider-wrap{display:grid; grid-template-columns:1fr 120px; gap:12px; align-items:center}

    input[type="range"]{appearance:none; width:100%; height:10px; background:linear-gradient(90deg, var(--accent), var(--accent-2)); border-radius:999px; outline:none}
    input[type="range"]::-webkit-slider-thumb{appearance:none; width:20px; height:20px; border-radius:50%; background:currentColor; color:#fff; border:3px solid #00000020; box-shadow:0 3px 10px #00000040; cursor:pointer}
    input[type="range"]::-moz-range-thumb{width:18px;height:18px;border:none;border-radius:50%;background:currentColor;cursor:pointer}
    input[type="number"], select{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.35); background:transparent; color:var(--text); font-size:14px; box-shadow: inset 0 2px 8px rgba(0,0,0,.04)}
    input[type="number"]:focus, select:focus{ outline:2px solid color-mix(in oklab, var(--accent) 40%, transparent)}

    .segmented{display:flex; background:rgba(148,163,184,.18); border-radius:12px; padding:4px; gap:4px; width:max-content}
    .segmented button{border:0;background:transparent;color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px}
    .segmented button[aria-pressed="true"]{background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#001018}

    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{border:0; background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#001018; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer}
    .btn.secondary{background:transparent; color:var(--text); border:1px dashed rgba(148,163,184,.5)}
    .btn.warn{background:linear-gradient(180deg, #ef4444, #f97316); color:#fff}

    .summary{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
    @media (max-width: 720px){ .summary{grid-template-columns:1fr;}}
    .metric{background:rgba(148,163,184,.12); border:1px solid rgba(148,163,184,.25); padding:14px; border-radius:12px}
    .metric .k{font-size:12px; color:var(--muted)}
    .metric .v{font-size:18px; font-weight:800}

    table{width:100%; border-collapse: collapse; font-size:13px}
    thead th{position:sticky; top:0; background:var(--panel); z-index:1}
    th, td{ padding:10px 8px; border-bottom:1px dashed rgba(148,163,184,.25); text-align:right}
    th:first-child, td:first-child{text-align:left}
    tbody tr:hover{ background:rgba(148,163,184,.08)}
    .table-wrap{max-height:420px; overflow:auto; border:1px solid rgba(148,163,184,.25); border-radius:12px}

    .note{color:var(--muted); font-size:12px}
    .flex{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .right{margin-left:auto}
    .pill{font-size:12px; padding:6px 8px; background:rgba(148,163,184,.18); border:1px solid rgba(148,163,184,.25); border-radius:999px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üí∏ Kalkulator kredytu got√≥wkowego ‚Äì offline</h1>
        <div class="sub">Dzia≈Ça w 100% lokalnie. Nowoczesny UI, suwaki + pola liczbowe, tabela z harmonogramem, nadp≈Çata, raty sta≈Çe lub malejƒÖce.</div>
      </div>
      <div class="segmented" role="tablist" aria-label="Tryb okresu">
        <button id="modeMonths" role="tab" aria-pressed="true">MiesiƒÖce</button>
        <button id="modeYears" role="tab" aria-pressed="false">Lata</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="inner">
          <h2 style="margin:0 0 8px 0; font-size:18px">Parametry</h2>
          <div class="row">
            <div>
              <div class="label">Kwota kredytu [PLN]</div>
              <div class="desc">Zakres: 1&nbsp;000 ‚Äì 500&nbsp;000</div>
            </div>
            <input id="amountInput" type="number" min="1000" max="500000" step="100" value="50000"/>
          </div>
          <div class="row">
            <div class="slider-wrap">
              <input id="amountRange" type="range" min="1000" max="500000" step="100" value="50000"/>
              <span class="pill" id="amountBadge">50&nbsp;000</span>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="label">Oprocentowanie roczne [%]</div>
              <div class="desc">Nominalne, sta≈Çe w skali roku</div>
            </div>
            <input id="rateInput" type="number" min="0" max="40" step="0.01" value="9.99"/>
          </div>
          <div class="row">
            <div class="slider-wrap">
              <input id="rateRange" type="range" min="0" max="40" step="0.01" value="9.99"/>
              <span class="pill" id="rateBadge">9,99%</span>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="label">Okres sp≈Çaty</div>
              <div class="desc">Prze≈ÇƒÖcznik u g√≥ry: miesiƒÖce / lata</div>
            </div>
            <input id="termInput" type="number" min="6" max="120" step="1" value="60"/>
          </div>
          <div class="row">
            <div class="slider-wrap">
              <input id="termRange" type="range" min="6" max="120" step="1" value="60"/>
              <span class="pill" id="termBadge">60 mies.</span>
            </div>
          </div>

          <div class="row">
            <div class="label">Rodzaj rat</div>
            <div class="flex">
              <label class="pill"><input type="radio" name="type" value="annuity" checked> Sta≈Çe (annuitet)</label>
              <label class="pill"><input type="radio" name="type" value="decreasing"> MalejƒÖce (r√≥wna kapita≈Çowa)</label>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="label">Wcze≈õniejsza sp≈Çata (nadp≈Çata)</div>
              <div class="desc">Opcjonalnie: miesiƒÖc i kwota nadp≈Çaty</div>
            </div>
            <label class="flex right"><input id="prepayToggle" type="checkbox"> &nbsp;W≈ÇƒÖcz</label>
          </div>

          <div id="prepayFields" style="display:none">
            <div class="row">
              <div class="label">MiesiƒÖc nadp≈Çaty (1 = pierwszy miesiƒÖc)</div>
              <input id="prepayMonth" type="number" min="1" value="12" />
            </div>
            <div class="row">
              <div class="label">Kwota nadp≈Çaty [PLN]</div>
              <input id="prepayAmount" type="number" min="0" step="100" value="10000" />
            </div>
            <div class="row">
              <div class="label">Strategia po nadp≈Çacie</div>
              <select id="prepayStrategy">
                <option value="shorten">Skr√≥ƒá okres (zostaw ratƒô)</option>
                <option value="lower">Obni≈º ratƒô (zostaw okres)</option>
              </select>
            </div>
          </div>

          <div class="actions" style="margin-top:14px">
            <button class="btn" id="calcBtn">Przelicz</button>
            <button class="btn secondary" id="saveBtn" title="Zapisz ustawienia w przeglƒÖdarce">Zapisz ustawienia</button>
            <button class="btn secondary" id="loadBtn" title="Wczytaj zapisane ustawienia">Wczytaj</button>
            <button class="btn warn" id="resetBtn">Wyczy≈õƒá</button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="inner">
          <h2 style="margin:0 0 8px 0; font-size:18px">Podsumowanie</h2>
          <div class="summary" id="summary">
            <div class="metric"><div class="k">Rata poczƒÖtkowa</div><div class="v" id="mPayment">‚Äì</div></div>
            <div class="metric"><div class="k">≈ÅƒÖczne odsetki</div><div class="v" id="mInterest">‚Äì</div></div>
            <div class="metric"><div class="k">≈ÅƒÖcznie do sp≈Çaty</div><div class="v" id="mTotal">‚Äì</div></div>
          </div>
          <div class="flex" style="margin-top:10px">
            <span class="note">Wyniki w PLN, zaokrƒÖglone do 2 miejsc.</span>
            <div class="right actions">
              <button class="btn secondary" id="csvBtn">Eksportuj CSV</button>
              <button class="btn secondary" id="collapseBtn">Zwi≈Ñ/Rozwi≈Ñ tabelƒô</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:20px">
      <div class="inner">
        <div class="flex" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0; font-size:18px">Harmonogram sp≈Çaty</h2>
          <span class="pill" id="rowsInfo">0 pozycji</span>
        </div>
        <div class="table-wrap" id="tableWrap">
          <table id="schedule">
            <thead>
              <tr>
                <th>#</th>
                <th>Rata</th>
                <th>Kapita≈Ç</th>
                <th>Odsetki</th>
                <th>Saldo po</th>
                <th>Uwagi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:20px">
      <div class="inner">
        <div class="flex" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0; font-size:16px">Testy wbudowane</h2>
          <button class="btn secondary" id="runTests">Uruchom testy</button>
        </div>
        <ul id="testsOut" class="note" style="margin:10px 0 0 0; padding-left:18px"></ul>
      </div>
    </section>

    <p class="note" style="margin-top:10px">Uwaga: kalkulator nie uwzglƒôdnia prowizji bankowych, ubezpiecze≈Ñ, ani zmiennej stopy ‚Äì zak≈Çada sta≈Çe nominalne % w skali roku.</p>
  </div>

<script>
(function(){
  const fmtPLN = (x) => x.toLocaleString('pl-PL', {minimumFractionDigits:2, maximumFractionDigits:2});

  // --- FIX: zainicjalizuj termMode PRZED u≈ºyciem w syncPair/formatterach ---
  let termMode = 'months';

  const els = {
    amountInput: document.getElementById('amountInput'),
    amountRange: document.getElementById('amountRange'),
    amountBadge: document.getElementById('amountBadge'),
    rateInput: document.getElementById('rateInput'),
    rateRange: document.getElementById('rateRange'),
    rateBadge: document.getElementById('rateBadge'),
    termInput: document.getElementById('termInput'),
    termRange: document.getElementById('termRange'),
    termBadge: document.getElementById('termBadge'),
    modeMonths: document.getElementById('modeMonths'),
    modeYears: document.getElementById('modeYears'),
    prepayToggle: document.getElementById('prepayToggle'),
    prepayFields: document.getElementById('prepayFields'),
    prepayMonth: document.getElementById('prepayMonth'),
    prepayAmount: document.getElementById('prepayAmount'),
    prepayStrategy: document.getElementById('prepayStrategy'),
    mPayment: document.getElementById('mPayment'),
    mInterest: document.getElementById('mInterest'),
    mTotal: document.getElementById('mTotal'),
    scheduleBody: document.querySelector('#schedule tbody'),
    rowsInfo: document.getElementById('rowsInfo'),
    csvBtn: document.getElementById('csvBtn'),
    calcBtn: document.getElementById('calcBtn'),
    resetBtn: document.getElementById('resetBtn'),
    saveBtn: document.getElementById('saveBtn'),
    loadBtn: document.getElementById('loadBtn'),
    collapseBtn: document.getElementById('collapseBtn'),
    tableWrap: document.getElementById('tableWrap'),
    runTests: document.getElementById('runTests'),
    testsOut: document.getElementById('testsOut')
  };

  // Sync helpers
  function syncPair(a, b, badge, formatter){
    const render = () => { badge.textContent = formatter(a.value); b.value = a.value; };
    a.addEventListener('input', render);
    b.addEventListener('input', () => { a.value = b.value; render(); });
    render();
  }
  syncPair(els.amountRange, els.amountInput, els.amountBadge, v=>Number(v).toLocaleString('pl-PL'));
  syncPair(els.rateRange, els.rateInput, els.rateBadge, v=>String(Number(v).toLocaleString('pl-PL', {minimumFractionDigits:2, maximumFractionDigits:2})).replace('.',',')+'%');
  syncPair(els.termRange, els.termInput, els.termBadge, v=>termMode==='months'?(`${v} mies.`):(`${v} lat`));

  // Term mode (months / years)
  function setMode(mode){
    termMode = mode;
    els.modeMonths.setAttribute('aria-pressed', mode==='months');
    els.modeYears.setAttribute('aria-pressed', mode==='years');
    // adjust ranges
    if(mode==='months'){
      els.termInput.min = 6; els.termInput.max = 120; els.termInput.step = 1;
      els.termRange.min = 6; els.termRange.max = 120; els.termRange.step = 1;
      if(Number(els.termInput.value) > 120){ els.termInput.value = 60; els.termRange.value = 60; }
    } else {
      els.termInput.min = 1; els.termInput.max = 10; els.termInput.step = 1;
      els.termRange.min = 1; els.termRange.max = 10; els.termRange.step = 1;
      if(Number(els.termInput.value) < 1 || Number(els.termInput.value) > 10){ els.termInput.value = 5; els.termRange.value = 5; }
    }
    // refresh badge
    els.termBadge.textContent = termMode==='months' ? `${els.termInput.value} mies.` : `${els.termInput.value} lat`;
  }
  els.modeMonths.addEventListener('click', ()=>setMode('months'));
  els.modeYears.addEventListener('click', ()=>setMode('years'));

  // Prepay toggle
  els.prepayToggle.addEventListener('change',()=>{
    els.prepayFields.style.display = els.prepayToggle.checked ? 'block' : 'none';
  });

  // Storage helpers
  const KEY = 'loanCalcSettingsV1';
  els.saveBtn.addEventListener('click', ()=>{
    const data = collectInputs();
    localStorage.setItem(KEY, JSON.stringify(data));
    alert('Zapisano ustawienia.');
  });
  els.loadBtn.addEventListener('click', ()=>{
    const raw = localStorage.getItem(KEY);
    if(!raw){ alert('Brak zapisanych ustawie≈Ñ.'); return; }
    const d = JSON.parse(raw);
    applyInputs(d);
  });

  function collectInputs(){
    return {
      amount: +els.amountInput.value,
      rate: +els.rateInput.value,
      term: +els.termInput.value,
      termMode,
      type: document.querySelector('input[name="type"]:checked').value,
      prepayEnabled: els.prepayToggle.checked,
      prepayMonth: +els.prepayMonth.value,
      prepayAmount: +els.prepayAmount.value,
      prepayStrategy: els.prepayStrategy.value
    };
  }
  function applyInputs(d){
    els.amountInput.value = els.amountRange.value = d.amount;
    els.rateInput.value = els.rateRange.value = d.rate;
    setMode(d.termMode||'months');
    els.termInput.value = els.termRange.value = d.term;
    document.querySelector(`input[name="type"][value="${d.type}"]`).checked = true;
    els.prepayToggle.checked = !!d.prepayEnabled; els.prepayFields.style.display = els.prepayToggle.checked?'block':'none';
    els.prepayMonth.value = d.prepayMonth||12;
    els.prepayAmount.value = d.prepayAmount||0;
    els.prepayStrategy.value = d.prepayStrategy||'shorten';
    // Update badges
    els.amountBadge.textContent = Number(d.amount).toLocaleString('pl-PL');
    els.rateBadge.textContent = String(Number(d.rate).toLocaleString('pl-PL', {minimumFractionDigits:2, maximumFractionDigits:2})).replace('.',',')+'%';
    els.termBadge.textContent = d.termMode==='months' ? `${d.term} mies.` : `${d.term} lat`;
  }

  els.resetBtn.addEventListener('click', ()=>{
    applyInputs({amount:50000, rate:9.99, term:60, termMode:'months', type:'annuity', prepayEnabled:false, prepayMonth:12, prepayAmount:10000, prepayStrategy:'shorten'});
    clearTable();
    updateSummary(0,0,0);
  });

  // Core calculation
  function calculate(){
    const {amount, rate, term, termMode:tm, type, prepayEnabled, prepayMonth, prepayAmount, prepayStrategy} = collectInputs();

    const n = tm==='months' ? term : term*12; // months
    const r = (rate/100)/12; // monthly rate

    let schedule = [];
    let principal = amount;
    let annuityPayment = 0;

    if(type==='annuity'){
      annuityPayment = r>0 ? principal * r / (1 - Math.pow(1+r, -n)) : principal / n;
    }

    const addRow = (i, payment, capital, interest, balance, note='')=>{
      schedule.push({i, payment, capital, interest, balance, note});
    }

    function finishToZero(startIndex, monthsLeft, pmt, rMonthly, principalStart){
      // iterate until principal paid
      let bal = principalStart;
      let idx = startIndex;
      let count = monthsLeft;
      while(bal > 0 && count>0){
        let interest = rMonthly>0 ? bal * rMonthly : 0;
        let capital = Math.min(pmt - interest, bal);
        let payment = capital + interest;
        bal = +(bal - capital).toFixed(10);
        addRow(idx++, payment, capital, interest, Math.max(0, bal));
        count--;
      }
      // if still bal > 0 after planned months, keep paying same pmt until cleared
      while(bal > 0 && pmt>0){
        let interest = rMonthly>0 ? bal * rMonthly : 0;
        let capital = Math.min(pmt - interest, bal);
        let payment = capital + interest;
        bal = +(bal - capital).toFixed(10);
        addRow(idx++, payment, capital, interest, Math.max(0, bal));
      }
      return idx-1; // last index used
    }

    if(type==='annuity'){
      let i = 1; let bal = principal;
      for(; i<=n; i++){
        let interest = r>0 ? bal * r : 0;
        let capital = Math.min(annuityPayment - interest, bal);
        let payment = capital + interest;
        bal = +(bal - capital).toFixed(10);
        let note = '';
        if(collectInputs().prepayEnabled && i===prepayMonth){
          const extra = Math.min(prepayAmount, Math.max(0, bal));
          if(extra>0){
            bal = +(bal - extra).toFixed(10);
            note = `Nadp≈Çata ${fmtPLN(extra)}`;
            if(prepayStrategy==='lower'){
              const remain = n - i; // months after this row
              const newPmt = r>0 ? bal * r / (1 - Math.pow(1+r, -remain)) : (remain>0? bal/remain : bal);
              addRow(i, payment+extra, capital+extra, interest, Math.max(0, bal), note);
              // continue with new payment
              i = finishToZero(i+1, remain, newPmt, r, bal)+1; // finish and break
              break;
            } else {
              // shorten: keep same payment amount
              addRow(i, payment+extra, capital+extra, interest, Math.max(0, bal), note);
              i = finishToZero(i+1, n - i, annuityPayment, r, bal)+1;
              break;
            }
          }
        }
        addRow(i, payment, capital, interest, Math.max(0, bal), note);
        if(bal<=0) break;
      }
    } else {
      // decreasing (equal principal)
      let equalCapital = principal / n;
      let bal = principal;
      for(let i=1; i<=n; i++){
        let interest = r>0 ? bal * r : 0;
        let capital = Math.min(equalCapital, bal);
        let payment = capital + interest;
        let note = '';
        // Apply prepay at month i
        if(collectInputs().prepayEnabled && i===prepayMonth){
          const extra = Math.min(prepayAmount, Math.max(0, bal - capital)); // apply after this month's capital
          if(extra>0){
            note = `Nadp≈Çata ${fmtPLN(extra)}`;
            if(prepayStrategy==='lower'){
              // apply this month
              payment += extra; capital += extra; bal = +(bal - capital).toFixed(10);
              addRow(i, payment, capital, interest, Math.max(0, bal), note);
              const remain = n - i;
              if(remain>0){
                equalCapital = bal / remain;
                for(let k=1; k<=remain; k++){
                  let int2 = r>0 ? bal * r : 0;
                  let cap2 = Math.min(equalCapital, bal);
                  let pay2 = cap2 + int2;
                  bal = +(bal - cap2).toFixed(10);
                  addRow(i+k, pay2, cap2, int2, Math.max(0, bal));
                  if(bal<=0) break;
                }
              }
              break;
            } else {
              // shorten term: keep equalCapital at original level
              payment += extra; capital += extra; bal = +(bal - capital).toFixed(10);
              addRow(i, payment, capital, interest, Math.max(0, bal), note);
              let idx = i+1;
              while(bal>0){
                let int2 = r>0 ? bal * r : 0;
                let cap2 = Math.min(equalCapital, bal);
                let pay2 = cap2 + int2;
                bal = +(bal - cap2).toFixed(10);
                addRow(idx++, pay2, cap2, int2, Math.max(0, bal));
              }
              break;
            }
          } else {
            // no extra, proceed normally
            bal = +(bal - capital).toFixed(10);
            addRow(i, payment, capital, interest, Math.max(0, bal), note);
          }
        } else {
          bal = +(bal - capital).toFixed(10);
          addRow(i, payment, capital, interest, Math.max(0, bal), note);
        }
        if(bal<=0) break;
      }
    }

    // compute totals
    const sumPayment = schedule.reduce((a,b)=>a+b.payment,0);
    const sumInterest = schedule.reduce((a,b)=>a+b.interest,0);

    renderTable(schedule);
    updateSummary(schedule[0]?.payment||0, sumInterest, schedule.reduce((a,b)=>a+b.payment,0));
  }

  function renderTable(rows){
    clearTable();
    const frag = document.createDocumentFragment();
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      const td = (t, alignRight=true)=>{ const x = document.createElement('td'); x.textContent = t; if(!alignRight) x.style.textAlign='left'; return x; };
      tr.appendChild(td(r.i, false));
      tr.appendChild(td(fmtPLN(r.payment)));
      tr.appendChild(td(fmtPLN(r.capital)));
      tr.appendChild(td(fmtPLN(r.interest)));
      tr.appendChild(td(fmtPLN(Math.max(0,r.balance))));
      tr.appendChild(td(r.note || '‚Äî'));
      frag.appendChild(tr);
    });
    els.scheduleBody.appendChild(frag);
    els.rowsInfo.textContent = `${rows.length} pozycji`;
  }
  function clearTable(){ els.scheduleBody.innerHTML=''; els.rowsInfo.textContent = '0 pozycji'; }

  function updateSummary(pmt, interest, total){
    els.mPayment.textContent = pmt? `${fmtPLN(pmt)} PLN` : '‚Äì';
    els.mInterest.textContent = interest? `${fmtPLN(interest)} PLN` : '‚Äì';
    els.mTotal.textContent = total? `${fmtPLN(total)} PLN` : '‚Äì';
  }

  // CSV export
  els.csvBtn.addEventListener('click', ()=>{
    const rows = [["#","Rata","Kapita≈Ç","Odsetki","Saldo po","Uwagi"]];
    document.querySelectorAll('#schedule tbody tr').forEach(tr=>{
      rows.push([...tr.children].map(td=>td.textContent.replace(/\u00A0/g,' ')));
    });
    const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}`+`"`).join(';')).join('\n');
    const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'harmonogram.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  });

  // Collapse
  let collapsed=false;
  els.collapseBtn.addEventListener('click', ()=>{
    collapsed = !collapsed;
    els.tableWrap.style.maxHeight = collapsed ? '0px' : '420px';
    els.tableWrap.style.overflow = collapsed ? 'hidden' : 'auto';
  });

  // Bind calculate
  els.calcBtn.addEventListener('click', calculate);

  // --- Proste testy wbudowane ---
  function runTests(){
    const out = [];
    const push = (name, pass, detail='')=> out.push({name, pass, detail});

    // Test 1: r=0, annuitet powinien r√≥wnaƒá siƒô kwocie/n
    (function(){
      const backup = JSON.stringify(collectInputs());
      applyInputs({amount:12000, rate:0, term:12, termMode:'months', type:'annuity', prepayEnabled:false});
      const n = 12; const expected = 12000/n;
      const {amount, rate, term, termMode:tm, type} = collectInputs();
      const r = (rate/100)/12; const pmt = r>0 ? amount*r/(1-Math.pow(1+r, -(tm==='months'?term:term*12))) : amount/(tm==='months'?term:term*12);
      push('Annuitet przy r=0', Math.abs(pmt-expected)<1e-8, `pmt=${pmt}, expected=${expected}`);
      applyInputs(JSON.parse(backup));
    })();

    // Test 2: malejƒÖce ‚Äì pierwsza rata > ostatnia przy r>0
    (function(){
      const backup = JSON.stringify(collectInputs());
      applyInputs({amount:10000, rate:12, term:10, termMode:'months', type:'decreasing', prepayEnabled:false});
      const n=10, r=0.12/12, cap=10000/n; let bal=10000;
      const first = cap + bal*r; bal -= cap; for(let i=2;i<=n;i++){var tmp = cap + bal*r; bal -= cap; if(i===n){var last = tmp;}}
      push('MalejƒÖce: pierwsza rata > ostatnia', first>last, `first=${first}, last=${last}`);
      applyInputs(JSON.parse(backup));
    })();

    // Test 3: nadp≈Çata skracajƒÖca ‚Äì suma rat po nadp≈Çacie mniejsza ni≈º bez nadp≈Çaty
    (function(){
      const backup = JSON.stringify(collectInputs());
      applyInputs({amount:50000, rate:10, term:24, termMode:'months', type:'annuity', prepayEnabled:false});
      // baseline
      const base = (function(){
        const {amount, rate, term} = collectInputs();
        const n = term; const r = (rate/100)/12; const pmt = r>0 ? amount*r/(1-Math.pow(1+r,-n)) : amount/n;
        let bal=amount, sum=0; for(let i=1;i<=n;i++){ let int=bal*r, cap=pmt-int; bal-=cap; sum+=pmt; }
        return sum;
      })();
      // with prepay
      applyInputs({amount:50000, rate:10, term:24, termMode:'months', type:'annuity', prepayEnabled:true, prepayMonth:6, prepayAmount:10000, prepayStrategy:'shorten'});
      const withPre = (function(){
        const {amount, rate, term, prepayMonth, prepayAmount} = collectInputs();
        const n = term; const r = (rate/100)/12; const pmt = r>0 ? amount*r/(1-Math.pow(1+r,-n)) : amount/n;
        let bal=amount, sum=0; for(let i=1;i<=n;i++){ let int=bal*r, cap=pmt-int; bal-=cap; sum+=pmt; if(i===prepayMonth){ bal-=prepayAmount; sum+=prepayAmount; if(bal<0) bal=0; } if(bal<=0) break; }
        return sum;
      })();
      push('Nadp≈Çata (skracanie) zmniejsza sumƒô sp≈Çat', withPre<base, `base=${base}, withPre=${withPre}`);
      applyInputs(JSON.parse(backup));
    })();

    els.testsOut.innerHTML = out.map(r=>`<li>${r.pass? '‚úÖ':'‚ùå'} <strong>${r.name}</strong> <span class="note">${r.detail}</span></li>`).join('');
  }
  els.runTests.addEventListener('click', runTests);

  // Initial state
  setMode('months');
  calculate();
})();
</script>
</body>
</html>
