<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator kredytu got√≥wkowego ‚Äì offline</title>
  <style>
    :root{
      /* üîµ Niebieski schemat kolor√≥w */
      --bg: #0b1220;
      --panel: #0e1726;
      --panel-2:#0f1b2e;
      --text: #e6edf3;
      --muted:#a9b4bf;
      --accent: #3b82f6;   /* blue-500 */
      --accent-2:#60a5fa; /* blue-400 */
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#eef2ff; --panel:#ffffff; --panel-2:#eff6ff; --text:#0b1220; --muted:#425466; --accent:#2563eb; --accent-2:#3b82f6; --danger:#e11d48; --warn:#f59e0b; --shadow: 0 10px 24px rgba(2,6,23,.08);} 
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:radial-gradient(1200px 800px at 80% -10%, rgba(59,130,246,.18), transparent), radial-gradient(900px 600px at -10% 100%, rgba(96,165,250,.14), transparent), var(--bg); color:var(--text)}
    .container{max-width:1200px;margin:40px auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:20px}
    h1{margin:0;font-size:clamp(22px,3vw,32px);letter-spacing:.3px}
    .sub{color:var(--muted);font-size:14px}

    .grid{display:grid;grid-template-columns: 1.1fr .9fr; gap: 20px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;}}

    .card{background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid rgba(148,163,184,.18); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card .inner{padding:18px 18px}

    .row{display:grid; grid-template-columns: 1fr 160px; gap:16px; align-items:center; margin:14px 0; position:relative}
    .row .label{font-weight:600; font-size:14px}
    .row .desc{font-size:12px;color:var(--muted);margin-top:4px}

    .info-icon { position:absolute; right:-24px; color:var(--accent); cursor:help; font-weight:bold; }

    /* üîß Slider z przyciskami +/- */
    .slider-wrap{display:grid; grid-template-columns:auto 1fr auto auto; gap:8px; align-items:center}
    .stepper{ display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid rgba(148,163,184,.35); background:transparent; color:var(--text); cursor:pointer; font-size:18px; font-weight:700; user-select:none }
    .stepper:active{ transform: translateY(1px) }

    input[type="range"]{appearance:none; width:100%; height:10px; background:linear-gradient(90deg, var(--accent), var(--accent-2)); border-radius:999px; outline:none}
    input[type="range"]::-webkit-slider-thumb{appearance:none; width:20px; height:20px; border-radius:50%; background:#fff; border:3px solid color-mix(in oklab, var(--accent) 55%, #0000); box-shadow:0 3px 10px #00000040; cursor:pointer}
    input[type="range"]::-moz-range-thumb{width:18px;height:18px;border:none;border-radius:50%;background:#fff; cursor:pointer}

    input[type="number"], select{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.35); background:transparent; color:var(--text); font-size:14px; box-shadow: inset 0 2px 8px rgba(0,0,0,.04)}
    input[type="number"]:focus, select:focus{ outline:2px solid color-mix(in oklab, var(--accent) 40%, transparent)}

    .segmented{display:flex; background:rgba(148,163,184,.18); border-radius:12px; padding:4px; gap:4px; width:max-content}
    .segmented button{border:0;background:transparent;color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px}
    .segmented button[aria-pressed="true"]{background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#001018}

    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{border:0; background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#001018; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer}
    .btn.secondary{background:transparent; color:var(--text); border:1px dashed rgba(148,163,184,.5)}
    .btn.warn{background:linear-gradient(180deg, #ef4444, #f97316); color:#fff}

    .summary{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
    @media (max-width: 720px){ .summary{grid-template-columns:1fr;}}
    .metric{background:rgba(148,163,184,.12); border:1px solid rgba(148,163,184,.25); padding:14px; border-radius:12px}
    .metric .k{font-size:12px; color:var(--muted)}
    .metric .v{font-size:18px; font-weight:800}

    table{width:100%; border-collapse: collapse; font-size:13px}
    thead th{position:sticky; top:0; background:var(--panel); z-index:1}
    th, td{ padding:10px 8px; border-bottom:1px dashed rgba(148,163,184,.25); text-align:right}
    th:first-child, td:first-child{text-align:left}
    tbody tr:hover{ background:rgba(148,163,184,.08)}
    .table-wrap{max-height:420px; overflow:auto; border:1px solid rgba(148,163,184,.25); border-radius:12px}

    .note{color:var(--muted); font-size:12px}
    .flex{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .right{margin-left:auto}
    .pill{font-size:12px; padding:6px 8px; background:rgba(148,163,184,.18); border:1px solid rgba(148,163,184,.25); border-radius:999px}
    .hint{font-size:12px; color:var(--warn); margin-top:6px}

    /* üì± Mobile: slider poni≈ºej kwoty (i czytelny) */
    @media (max-width:560px){
      .row{ grid-template-columns:1fr; }
      .slider-wrap{ grid-template-columns: 1fr; grid-auto-flow: row; }
      .slider-wrap .stepper{ width:100%; height:38px }
      .slider-wrap .pill{ justify-self:end }
    }

    /* üîÄ Toggle dwustanowy dla typu rat ‚Äì dopasowany rozmiar */
    .toggle-wrap{display:flex; align-items:center; gap:10px}
    .toggle{
  position:relative;
  display:inline-block;
  width:54px; height:26px;
  background:rgba(148,163,184,.25);
  border:1px solid rgba(148,163,184,.35);
  border-radius:999px;
  cursor:pointer;
  transition:background .2s;
  overflow:hidden;
}
    .toggle::before{
  content:'';
  position:absolute;
  top:2px; left:2px;
  width:22px; height:22px;
  background:#fff; border-radius:50%;
  box-shadow:0 1px 4px rgba(0,0,0,.35);
  transition:left .2s;
  z-index:1;
}
    .toggle[aria-pressed="true"]{ /* active background */ background:linear-gradient(180deg, var(--accent), var(--accent-2)); }
    .toggle[aria-pressed="true"]::before{ left:calc(100% - 24px); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üí∏ Kalkulator kredytu got√≥wkowego ‚Äì offline</h1>
        <div class="sub">Dzia≈Ça w 100% lokalnie. Nowoczesny UI, suwaki + pola liczbowe, tabela z harmonogramem, nadp≈Çata, raty sta≈Çe lub malejƒÖce.</div>
      </div>
      <div class="segmented" role="tablist" aria-label="Tryb okresu">
        <button id="modeMonths" role="tab" aria-pressed="true">MiesiƒÖce</button>
        <button id="modeYears" role="tab" aria-pressed="false">Lata</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="inner">
          <h2 style="margin:0 0 8px 0; font-size:18px">Parametry</h2>
          <div class="row">
            <div>
              <div class="label">Kwota kredytu [PLN]</div>
              <div class="desc">Dowolna warto≈õƒá liczbowa</div>
            </div>
            <input id="amountInput" type="number" min="0" step="any" value="20000"/>
          </div>
          <div class="row">
            <div class="slider-wrap">
              <button class="stepper" id="amountMinus" aria-label="Zmniejsz">‚àí</button>
              <input id="amountRange" type="range" min="0" max="5000000" step="1" value="20000"/>
              <button class="stepper" id="amountPlus" aria-label="Zwiƒôksz">+</button>
              <span class="pill" id="amountBadge">20&nbsp;000</span>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="label">Oprocentowanie roczne [%]</div>
              <div class="desc">Dowolna warto≈õƒá procentowa</div>
            </div>
            <input id="rateInput" type="number" min="0" step="any" value="9.49"/>
          </div>
          <div class="row">
            <div class="slider-wrap">
              <button class="stepper" id="rateMinus" aria-label="Zmniejsz">‚àí</button>
              <input id="rateRange" type="range" min="0" max="40" step="0.01" value="9.49"/>
              <button class="stepper" id="ratePlus" aria-label="Zwiƒôksz">+</button>
              <span class="pill" id="rateBadge">9,49%</span>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="label">Okres sp≈Çaty <span class="info-icon" title="Kredyty mo≈ºna braƒá tylko na wielokrotno≈õci 12 miesiƒôcy">‚ÑπÔ∏è</span></div>
              <div class="desc">Dowolna liczba miesiƒôcy lub lat</div>
            </div>
            <input id="termInput" type="number" min="1" step="1" value="48"/>
          </div>
          <div class="row">
            <div class="slider-wrap">
              <button class="stepper" id="termMinus" aria-label="Zmniejsz">‚àí</button>
              <input id="termRange" type="range" min="1" max="360" step="1" value="48"/>
              <button class="stepper" id="termPlus" aria-label="Zwiƒôksz">+</button>
              <span class="pill" id="termBadge">48 mies.</span>
            </div>
            <div class="hint" id="termHint" aria-live="polite" style="display:none"></div>
          </div>

          <div class="row">
            <div class="label">Rodzaj rat</div>
            <div class="toggle-wrap">
              <span>Sta≈Çe</span>
              <button id="typeToggle" class="toggle" role="switch" aria-pressed="false" aria-label="Prze≈ÇƒÖcz rodzaj rat"></button>
              <span>MalejƒÖce</span>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="label">Wcze≈õniejsza sp≈Çata (nadp≈Çata)</div>
              <div class="desc">Opcjonalnie: miesiƒÖc i kwota nadp≈Çaty</div>
            </div>
            <label class="flex right"><input id="prepayToggle" type="checkbox"> &nbsp;W≈ÇƒÖcz</label>
          </div>

          <div id="prepayFields" style="display:none">
            <div class="row">
              <div class="label">MiesiƒÖc nadp≈Çaty (1 = pierwszy miesiƒÖc)</div>
              <input id="prepayMonth" type="number" min="1" value="12" />
            </div>
            <div class="row">
              <div class="label">Kwota nadp≈Çaty [PLN]</div>
              <input id="prepayAmount" type="number" min="0" step="any" value="10000" />
            </div>
            <div class="row">
              <div class="label">Strategia po nadp≈Çacie</div>
              <select id="prepayStrategy">
                <option value="shorten">Skr√≥ƒá okres (zostaw ratƒô)</option>
                <option value="lower">Obni≈º ratƒô (zostaw okres)</option>
              </select>
            </div>
          </div>

          <div class="actions" style="margin-top:14px">
            <button class="btn" id="calcBtn">Przelicz</button>
            <button class="btn secondary" id="saveBtn" title="Zapisz ustawienia w przeglƒÖdarce">Zapisz ustawienia</button>
            <button class="btn secondary" id="loadBtn" title="Wczytaj zapisane ustawienia">Wczytaj</button>
            <button class="btn warn" id="resetBtn">Wyczy≈õƒá</button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="inner">
          <h2 style="margin:0 0 8px 0; font-size:18px">Podsumowanie</h2>
          <div class="summary" id="summary">
            <div class="metric"><div class="k">Rata poczƒÖtkowa</div><div class="v" id="mPayment">‚Äì</div></div>
            <div class="metric"><div class="k">≈ÅƒÖczne odsetki</div><div class="v" id="mInterest">‚Äì</div></div>
            <div class="metric"><div class="k">≈ÅƒÖcznie do sp≈Çaty</div><div class="v" id="mTotal">‚Äì</div></div>
          </div>
          <div class="flex" style="margin-top:10px">
            <span class="note">Wyniki w PLN, zaokrƒÖglone do 2 miejsc.</span>
            <div class="right actions">
              <button class="btn secondary" id="csvBtn">Eksportuj CSV</button>
              <button class="btn secondary" id="collapseBtn">Zwi≈Ñ/Rozwi≈Ñ tabelƒô</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:20px">
      <div class="inner">
        <div class="flex" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0; font-size:18px">Harmonogram sp≈Çaty</h2>
          <span class="pill" id="rowsInfo">0 pozycji</span>
        </div>
        <div class="table-wrap" id="tableWrap">
          <table id="schedule">
            <thead>
              <tr>
                <th>#</th>
                <th>Rata</th>
                <th>Kapita≈Ç</th>
                <th>Odsetki</th>
                <th>Saldo po</th>
                <th>Uwagi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:20px">
      <div class="inner">
        <div class="flex" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0; font-size:16px">Testy wbudowane</h2>
          <button class="btn secondary" id="runTests">Uruchom testy</button>
        </div>
        <ul id="testsOut" class="note" style="margin:10px 0 0 0; padding-left:18px"></ul>
      </div>
    </section>

    <p class="note" style="margin:10px 0 6px">Uwaga: kalkulator nie uwzglƒôdnia prowizji bankowych, ubezpiecze≈Ñ, ani zmiennej stopy ‚Äì zak≈Çada sta≈Çe nominalne % w skali roku.</p>
    <p class="note">Wersja: <strong id="appVersion">1.03</strong></p>
  </div>

<script>
(function(){
  const fmtPLN = (x) => Number(x).toLocaleString('pl-PL', {minimumFractionDigits:2, maximumFractionDigits:2});

  // Inicjalizacja trybu okresu zanim jest u≈ºyty
  let termMode = 'months';
  // Bie≈ºƒÖcy typ rat: 'annuity' (sta≈Çe) / 'decreasing' (malejƒÖce)
  let loanType = 'annuity';

  const els = {
    amountInput: document.getElementById('amountInput'),
    amountRange: document.getElementById('amountRange'),
    amountMinus: document.getElementById('amountMinus'),
    amountPlus: document.getElementById('amountPlus'),
    amountBadge: document.getElementById('amountBadge'),

    rateInput: document.getElementById('rateInput'),
    rateRange: document.getElementById('rateRange'),
    rateMinus: document.getElementById('rateMinus'),
    ratePlus: document.getElementById('ratePlus'),
    rateBadge: document.getElementById('rateBadge'),

    termInput: document.getElementById('termInput'),
    termRange: document.getElementById('termRange'),
    termMinus: document.getElementById('termMinus'),
    termPlus: document.getElementById('termPlus'),
    termBadge: document.getElementById('termBadge'),
    termHint: document.getElementById('termHint'),

    typeToggle: document.getElementById('typeToggle'),

    modeMonths: document.getElementById('modeMonths'),
    modeYears: document.getElementById('modeYears'),

    prepayToggle: document.getElementById('prepayToggle'),
    prepayFields: document.getElementById('prepayFields'),
    prepayMonth: document.getElementById('prepayMonth'),
    prepayAmount: document.getElementById('prepayAmount'),
    prepayStrategy: document.getElementById('prepayStrategy'),

    mPayment: document.getElementById('mPayment'),
    mInterest: document.getElementById('mInterest'),
    mTotal: document.getElementById('mTotal'),
    scheduleBody: document.querySelector('#schedule tbody'),
    rowsInfo: document.getElementById('rowsInfo'),
    csvBtn: document.getElementById('csvBtn'),
    calcBtn: document.getElementById('calcBtn'),
    resetBtn: document.getElementById('resetBtn'),
    saveBtn: document.getElementById('saveBtn'),
    loadBtn: document.getElementById('loadBtn'),
    collapseBtn: document.getElementById('collapseBtn'),
    tableWrap: document.getElementById('tableWrap'),
    runTests: document.getElementById('runTests'),
    testsOut: document.getElementById('testsOut')
  };

  // Debounce timer PRZED u≈ºyciem
  let recalcTimer = null;
  function scheduleRecalc(){
    clearTimeout(recalcTimer);
    recalcTimer = setTimeout(calculate, 50);
    updateTermHint();
  }

  // Pomocnik: krok wg step range'a
  function stepBy(rangeEl, delta){
    const step = Number(rangeEl.step||1);
    const v = Number(rangeEl.value);
    const min = Number(rangeEl.min||-Infinity);
    const max = Number(rangeEl.max||Infinity);
    let nv = v + delta*step;
    nv = Math.min(max, Math.max(min, nv));
    rangeEl.value = (step%1? Number(nv.toFixed(2)) : nv); // 0.01 dla %
    rangeEl.dispatchEvent(new Event('input', {bubbles:true}));
  }

  // Auto-repeat dla przytrzymania +/- (mouse & touch)
  function attachAutoRepeat(btn, rangeEl, delta){
    let holdTimer = null, repeatTimer = null;
    const start = (e)=>{
      e.preventDefault();
      stepBy(rangeEl, delta);
      clearTimeout(holdTimer); clearInterval(repeatTimer);
      holdTimer = setTimeout(()=>{
        repeatTimer = setInterval(()=>stepBy(rangeEl, delta), 60);
      }, 350);
    };
    const stop = ()=>{ clearTimeout(holdTimer); clearInterval(repeatTimer); };
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, {passive:false});
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>btn.addEventListener(ev, stop));
  }

  // Dwukierunkowa synchronizacja zakres<->pole + od≈õwie≈ºanie badge i auto-przeliczenie
  function syncPair(rangeEl, inputEl, badgeEl, formatBadge){
    const renderFromRange = () => {
      inputEl.value = rangeEl.value;
      badgeEl && (badgeEl.textContent = formatBadge(rangeEl.value));
      scheduleRecalc();
    };
    const renderFromInput = () => {
      const v = inputEl.value === '' ? 0 : Number(inputEl.value);
      if(rangeEl.min !== '') rangeEl.value = Math.min(Math.max(v, Number(rangeEl.min)), Number(rangeEl.max));
      else rangeEl.value = v;
      badgeEl && (badgeEl.textContent = formatBadge(rangeEl.value));
      scheduleRecalc();
    };
    rangeEl.addEventListener('input', renderFromRange);
    inputEl.addEventListener('input', renderFromInput);
    renderFromRange();
  }

  // Sync + steppery
  syncPair(els.amountRange, els.amountInput, els.amountBadge, v=>Number(v).toLocaleString('pl-PL'));
  els.amountMinus.addEventListener('click', ()=>stepBy(els.amountRange, -1));
  els.amountPlus .addEventListener('click', ()=>stepBy(els.amountRange, +1));
  attachAutoRepeat(els.amountMinus, els.amountRange, -1);
  attachAutoRepeat(els.amountPlus , els.amountRange, +1);

  syncPair(els.rateRange, els.rateInput, els.rateBadge, v=>String(Number(v).toLocaleString('pl-PL', {minimumFractionDigits:2, maximumFractionDigits:2})).replace('.',',')+'%');
  els.rateMinus.addEventListener('click', ()=>stepBy(els.rateRange, -1));
  els.ratePlus .addEventListener('click', ()=>stepBy(els.rateRange, +1));
  attachAutoRepeat(els.rateMinus, els.rateRange, -1);
  attachAutoRepeat(els.ratePlus , els.rateRange, +1);

  syncPair(els.termRange, els.termInput, els.termBadge, v=>termMode==='months'?(`${v} mies.`):(`${v} lat`));
  els.termMinus.addEventListener('click', ()=>stepBy(els.termRange, -1));
  els.termPlus .addEventListener('click', ()=>stepBy(els.termRange, +1));
  attachAutoRepeat(els.termMinus, els.termRange, -1);
  attachAutoRepeat(els.termPlus , els.termRange, +1);

  // Term mode (months / years)
  function setMode(mode){
    termMode = mode;
    els.modeMonths.setAttribute('aria-pressed', mode==='months');
    els.modeYears.setAttribute('aria-pressed', mode==='years');
    els.termBadge.textContent = termMode==='months' ? `${els.termInput.value} mies.` : `${els.termInput.value} lat`;
    updateTermHint();
    scheduleRecalc();
  }
  els.modeMonths.addEventListener('click', ()=>setMode('months'));
  els.modeYears.addEventListener('click', ()=>setMode('years'));

  // Toggle rodzaju rat
  function setLoanType(newType){
    loanType = newType; // 'annuity' | 'decreasing'
    els.typeToggle.setAttribute('aria-pressed', loanType==='decreasing');
    scheduleRecalc();
  }
  els.typeToggle.addEventListener('click', ()=>{
    setLoanType(loanType==='annuity' ? 'decreasing' : 'annuity');
  });

  // Prepay toggle
  els.prepayToggle.addEventListener('change',()=>{
    els.prepayFields.style.display = els.prepayToggle.checked ? 'block' : 'none';
  });

  // Storage helpers
  const KEY = 'loanCalcSettingsV1';
  els.saveBtn.addEventListener('click', ()=>{
    const data = collectInputs();
    localStorage.setItem(KEY, JSON.stringify(data));
    alert('Zapisano ustawienia.');
  });
  els.loadBtn.addEventListener('click', ()=>{
    const raw = localStorage.getItem(KEY);
    if(!raw){ alert('Brak zapisanych ustawie≈Ñ.'); return; }
    const d = JSON.parse(raw);
    applyInputs(d);
  });

  function collectInputs(){
    return {
      amount: +els.amountInput.value,
      rate: +els.rateInput.value,
      term: +els.termInput.value,
      termMode,
      type: loanType,
      prepayEnabled: els.prepayToggle.checked,
      prepayMonth: +els.prepayMonth.value,
      prepayAmount: +els.prepayAmount.value,
      prepayStrategy: els.prepayStrategy.value
    };
  }
  function applyInputs(d){
    els.amountInput.value = d.amount;
    els.amountRange.value = Math.min(Math.max(d.amount, Number(els.amountRange.min)), Number(els.amountRange.max));
    els.amountBadge.textContent = Number(els.amountRange.value).toLocaleString('pl-PL');

    els.rateInput.value = d.rate;
    els.rateRange.value = Math.min(Math.max(d.rate, Number(els.rateRange.min)), Number(els.rateRange.max));
    els.rateBadge.textContent = String(Number(els.rateRange.value).toLocaleString('pl-PL', {minimumFractionDigits:2, maximumFractionDigits:2})).replace('.',',')+'%';

    setMode(d.termMode||'months');
    els.termInput.value = d.term;
    els.termRange.value = Math.min(Math.max(d.term, Number(els.termRange.min)), Number(els.termRange.max));
    els.termBadge.textContent = termMode==='months' ? `${els.termInput.value} mies.` : `${els.termInput.value} lat`;

    setLoanType(d.type||'annuity');

    els.prepayToggle.checked = !!d.prepayEnabled; els.prepayFields.style.display = els.prepayToggle.checked?'block':'none';
    els.prepayMonth.value = d.prepayMonth||12;
    els.prepayAmount.value = d.prepayAmount||0;
    els.prepayStrategy.value = d.prepayStrategy||'shorten';
    updateTermHint();
  }

  els.resetBtn.addEventListener('click', ()=>{
    applyInputs({amount:20000, rate:9.49, term:48, termMode:'months', type:'annuity', prepayEnabled:false, prepayMonth:12, prepayAmount:10000, prepayStrategy:'shorten'});
    clearTable();
    updateSummary(0,0,0);
  });

  // Miƒôkka walidacja wielokrotno≈õci 12 mies.
  function isMultipleOf12(x){ return x % 12 === 0; }
  function termMultipleHintText(term, mode){
    if(mode==='years') return '';
    if(!Number.isFinite(term) || term<=0) return '';
    return isMultipleOf12(Math.floor(term)) ? '' : 'üí° Wskaz√≥wka: banki zwykle oferujƒÖ okresy bƒôdƒÖce wielokrotno≈õciƒÖ 12 mies. (12/24/36/‚Ä¶).';
  }
  function updateTermHint(){
    const t = Number(els.termInput.value);
    const msg = termMultipleHintText(t, termMode);
    if(msg){ els.termHint.textContent = msg; els.termHint.style.display = 'block'; }
    else { els.termHint.textContent=''; els.termHint.style.display = 'none'; }
  }
  els.termInput.addEventListener('input', updateTermHint);
  els.termRange.addEventListener('input', updateTermHint);

  // Przeliczanie
  function calculate(){
    const {amount, rate, term, termMode:tm, type, prepayEnabled, prepayMonth, prepayAmount, prepayStrategy} = collectInputs();
    if(!amount || !term){ clearTable(); updateSummary(0,0,0); return; }
    const n = tm==='months' ? Math.max(1, Math.floor(term)) : Math.max(1, Math.floor(term*12));
    const r = (rate/100)/12; // miesiƒôczna stopa

    let schedule = [];
    let principal = Math.max(0, amount);
    let annuityPayment = 0;

    if(type==='annuity'){
      annuityPayment = r>0 ? principal * r / (1 - Math.pow(1+r, -n)) : principal / n;
    }

    const addRow = (i, payment, capital, interest, balance, note='')=>{
      schedule.push({i, payment, capital, interest, balance, note});
    }

    function finishToZero(startIndex, monthsLeft, pmt, rMonthly, principalStart){
      let bal = principalStart;
      let idx = startIndex;
      let count = monthsLeft;
      while(bal > 0 && count>0){
        let interest = rMonthly>0 ? bal * rMonthly : 0;
        let capital = Math.min(pmt - interest, bal);
        let payment = capital + interest;
        bal = +(bal - capital).toFixed(10);
        addRow(idx++, payment, capital, interest, Math.max(0, bal));
        count--;
      }
      while(bal > 0 && pmt>0){
        let interest = rMonthly>0 ? bal * rMonthly : 0;
        let capital = Math.min(pmt - interest, bal);
        let payment = capital + interest;
        bal = +(bal - capital).toFixed(10);
        addRow(idx++, payment, capital, interest, Math.max(0, bal));
      }
      return idx-1;
    }

    if(type==='annuity'){
      let i = 1; let bal = principal;
      for(; i<=n; i++){
        let interest = r>0 ? bal * r : 0;
        let capital = Math.min(annuityPayment - interest, bal);
        let payment = capital + interest;
        bal = +(bal - capital).toFixed(10);
        let note = '';
        if(prepayEnabled && i===Math.floor(prepayMonth)){
          const extra = Math.min(prepayAmount, Math.max(0, bal));
          if(extra>0){
            bal = +(bal - extra).toFixed(10);
            note = `Nadp≈Çata ${fmtPLN(extra)}`;
            if(prepayStrategy==='lower'){
              const remain = n - i;
              const newPmt = r>0 ? bal * r / (1 - Math.pow(1+r, -remain)) : (remain>0? bal/remain : bal);
              addRow(i, payment+extra, capital+extra, interest, Math.max(0, bal), note);
              i = finishToZero(i+1, remain, newPmt, r, bal)+1; 
              break;
            } else {
              addRow(i, payment+extra, capital+extra, interest, Math.max(0, bal), note);
              i = finishToZero(i+1, n - i, annuityPayment, r, bal)+1;
              break;
            }
          }
        }
        addRow(i, payment, capital, interest, Math.max(0, bal), note);
        if(bal<=0) break;
      }
    } else {
      // malejƒÖce
      let equalCapital = principal / n;
      let bal = principal;
      for(let i=1; i<=n; i++){
        let interest = r>0 ? bal * r : 0;
        let capital = Math.min(equalCapital, bal);
        let payment = capital + interest;
        let note = '';
        if(prepayEnabled && i===Math.floor(prepayMonth)){
          const extra = Math.min(prepayAmount, Math.max(0, bal - capital));
          if(extra>0){
            note = `Nadp≈Çata ${fmtPLN(extra)}`;
            if(prepayStrategy==='lower'){
              payment += extra; capital += extra; bal = +(bal - capital).toFixed(10);
              addRow(i, payment, capital, interest, Math.max(0, bal), note);
              const remain = n - i;
              if(remain>0){
                equalCapital = bal / remain;
                for(let k=1; k<=remain; k++){
                  let int2 = r>0 ? bal * r : 0;
                  let cap2 = Math.min(equalCapital, bal);
                  let pay2 = cap2 + int2;
                  bal = +(bal - cap2).toFixed(10);
                  addRow(i+k, pay2, cap2, int2, Math.max(0, bal));
                  if(bal<=0) break;
                }
              }
              break;
            } else {
              payment += extra; capital += extra; bal = +(bal - capital).toFixed(10);
              addRow(i, payment, capital, interest, Math.max(0, bal), note);
              let idx = i+1;
              while(bal>0){
                let int2 = r>0 ? bal * r : 0;
                let cap2 = Math.min(equalCapital, bal);
                let pay2 = cap2 + int2;
                bal = +(bal - cap2).toFixed(10);
                addRow(idx++, pay2, cap2, int2, Math.max(0, bal));
              }
              break;
            }
          } else {
            bal = +(bal - capital).toFixed(10);
            addRow(i, payment, capital, interest, Math.max(0, bal), note);
          }
        } else {
          bal = +(bal - capital).toFixed(10);
          addRow(i, payment, capital, interest, Math.max(0, bal), note);
        }
        if(bal<=0) break;
      }
    }

    // Suma
    const sumInterest = schedule.reduce((a,b)=>a+b.interest,0);
    const sumPayment = schedule.reduce((a,b)=>a+b.payment,0);

    renderTable(schedule);
    updateSummary(schedule[0]?.payment||0, sumInterest, sumPayment);
  }

  function renderTable(rows){
    clearTable();
    const frag = document.createDocumentFragment();
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      const td = (t, alignRight=true)=>{ const x = document.createElement('td'); x.textContent = t; if(!alignRight) x.style.textAlign='left'; return x; };
      tr.appendChild(td(r.i, false));
      tr.appendChild(td(fmtPLN(r.payment)));
      tr.appendChild(td(fmtPLN(r.capital)));
      tr.appendChild(td(fmtPLN(r.interest)));
      tr.appendChild(td(fmtPLN(Math.max(0,r.balance))));
      tr.appendChild(td(r.note || '‚Äî'));
      frag.appendChild(tr);
    });
    els.scheduleBody.appendChild(frag);
    els.rowsInfo.textContent = `${rows.length} pozycji`;
  }
  function clearTable(){ els.scheduleBody.innerHTML=''; els.rowsInfo.textContent = '0 pozycji'; }

  function updateSummary(pmt, interest, total){
    els.mPayment.textContent = pmt? `${fmtPLN(pmt)} PLN` : '‚Äì';
    els.mInterest.textContent = interest? `${fmtPLN(interest)} PLN` : '‚Äì';
    els.mTotal.textContent = total? `${fmtPLN(total)} PLN` : '‚Äì';
  }

  // CSV export
  els.csvBtn.addEventListener('click', ()=>{
    const rows = [["#","Rata","Kapita≈Ç","Odsetki","Saldo po","Uwagi"]];
    document.querySelectorAll('#schedule tbody tr').forEach(tr=>{
      rows.push([...tr.children].map(td=>td.textContent.replace(/\u00A0/g,' ')));
    });
    const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}`+`"`).join(';')).join('\n');
    const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'harmonogram.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  });

  // Collapse
  let collapsed=false;
  els.collapseBtn.addEventListener('click', ()=>{
    collapsed = !collapsed;
    els.tableWrap.style.maxHeight = collapsed ? '0px' : '420px';
    els.tableWrap.style.overflow = collapsed ? 'hidden' : 'auto';
  });

  els.calcBtn.addEventListener('click', calculate);

  // Testy
  function runTests(){
    const out = [];
    const push = (name, pass, detail='')=> out.push({name, pass, detail});

    // Test 1
    (function(){
      const amount=12000, rate=0, term=12; const r=0; const n=12; const expected=amount/n;
      const pmt = r>0 ? amount*r/(1-Math.pow(1+r,-n)) : amount/n;
      push('Annuitet r=0', Math.abs(pmt-expected)<1e-8, `pmt=${pmt}, exp=${expected}`);
    })();

    // Test 2
    (function(){
      const amount=10000, rate=12, n=10, r=rate/100/12; let bal=amount; const cap=amount/n;
      const first = cap + bal*r; bal -= cap; let last=first; for(let i=2;i<=n;i++){ last = cap + bal*r; bal -= cap; }
      push('MalejƒÖce: pierwsza>ostatnia', first>last, `first=${first}, last=${last}`);
    })();

    // Test 3
    (function(){
      const amount=50000, rate=10, n=24, r=rate/100/12; const pmt = amount*r/(1-Math.pow(1+r,-n));
      let bal=amount, sum=0; for(let i=1;i<=n;i++){ let int=bal*r, cap=pmt-int; bal-=cap; sum+=pmt; }
      let base=sum;
      bal=amount; sum=0; for(let i=1;i<=n;i++){ let int=bal*r, cap=pmt-int; bal-=cap; sum+=pmt; if(i===6){ bal-=10000; sum+=10000; if(bal<0) bal=0; } if(bal<=0) break; }
      push('Nadp≈Çata skraca sumƒô', sum<base, `base=${base}, with=${sum}`);
    })();

    // Test 4: Debounce nie rzuca b≈Çƒôdem przy wielokrotnym wywo≈Çaniu
    (function(){
      let ok = true; let msg = '';
      try { scheduleRecalc(); scheduleRecalc(); scheduleRecalc(); } catch(e){ ok = false; msg = e?.message||String(e); }
      push('Debounce: scheduleRecalc bez b≈Çƒôd√≥w', ok, msg||'OK');
    })();

    // Test 5: Wielokrotno≈õƒá 12
    (function(){
      const t1 = 24, t2 = 18; const a1 = isMultipleOf12(t1), a2 = isMultipleOf12(t2);
      push('isMultipleOf12()', a1===true && a2===false, `24‚Üí${a1}, 18‚Üí${a2}`);
    })();

    // Test 6: Tekst podpowiedzi
    (function(){
      const m1 = termMultipleHintText(36,'months');
      const m2 = termMultipleHintText(18,'months');
      const m3 = termMultipleHintText(5,'years');
      push('termMultipleHintText()', m1==='' && m2!=='' && m3==='', `m1='${m1}', m2='${m2}', m3='${m3}'`);
    })();

    els.testsOut.innerHTML = out.map(r=>`<li>${r.pass? '‚úÖ':'‚ùå'} <strong>${r.name}</strong> <span class="note">${r.detail}</span></li>`).join('');
  }
  els.runTests.addEventListener('click', runTests);

  // Start ‚Äì domy≈õlne ustawienia z pro≈õby
  setMode('months');
  applyInputs({amount:20000, rate:9.49, term:48, termMode:'months', type:'annuity', prepayEnabled:false, prepayMonth:12, prepayAmount:10000, prepayStrategy:'shorten'});
  calculate();
})();
</script>
</body>
</html>
